<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- Copy the package's native libraries into the project, since it doesn't
	     seem you can link directly to libraries in the package folder. Except
	     for UWP, this is the one thing UWP seems to get right automatically. -->
	<Target Name="StereoKitLibraries" BeforeTargets="BeforeBuild" Condition="'$(OutputType)'!='Library' or ('$(TargetFrameworkIdentifier)'=='MonoAndroid' and '$(TargetPlatformIdentifier)'!='UAP')">
		<Message Importance="high" Text="[StereoKit NuGet] Copying native libraries into the project at $(BaseIntermediateOutputPath)lib"/>

		<ItemGroup>
			<SKSourceFolder Include="$(MSBuildThisFileDirectory)../runtimes/**/*.*" />
		</ItemGroup>
		<Copy
			SourceFiles        = "@(SKSourceFolder)"
			DestinationFolder  = "$(BaseIntermediateOutputPath)lib/%(RecursiveDir)"
			SkipUnchangedFiles = "true"/>
	</Target>

	<!-- Link libraries to Xamarin projects.  -->
	<ItemGroup Condition="'$(TargetFrameworkIdentifier)'=='MonoAndroid'">
		<AndroidNativeLibrary Abi="arm64-v8a" Include="$(BaseIntermediateOutputPath)lib/android-arm64-v8a/native/libStereoKitC.so"/>
		<AndroidNativeLibrary Abi="arm64-v8a" Include="$(BaseIntermediateOutputPath)lib/android-arm64-v8a/native/libopenxr_loader.so" />
	</ItemGroup>

	<!-- Win32 projects -->
	<ItemGroup Condition="'$(OutputType)'!='Library' and '$(TargetPlatformIdentifier)'=='Windows'">
		<None CopyToOutputDirectory="PreserveNewest" Link="StereoKitC.dll" Include="$(BaseIntermediateOutputPath)lib/win-x64/native/StereoKitC.dll" />
	</ItemGroup>

	<!-- Linux projects -->
	<ItemGroup Condition="'$(OutputType)'!='Library' and '$(TargetPlatformIdentifier)'=='Linux'">
		<None CopyToOutputDirectory="PreserveNewest" Link="libStereoKitC.so" Include="$(BaseIntermediateOutputPath)lib/linux-x64/native/libStereoKitC.so" />
	</ItemGroup>

	<!-- Compile shaders -->
	<ItemGroup>
		<SKShaders Include="$(ProjectDir)Assets/**/*.hlsl" />
	</ItemGroup>
	<Target Name="StereoKitShaders" BeforeTargets="BeforeBuild" Condition="'$(OS)'=='Windows_NT'" Inputs="@(SKShaders)"  Outputs="@(SKShaders->'%(Filename).sks')">
		<Message Importance="high" Text="[StereoKit NuGet] Compiling shader %(SKShaders.Filename)%(SKShaders.Extension)"/>
		<Exec Command="&quot;$(MSBuildThisFileDirectory)../tools/skshaderc.exe&quot; -o3 -e -t xge -i &quot;$(MSBuildThisFileDirectory)../tools/include/&quot;  &quot;Assets/%(SKShaders.RecursiveDir)%(SKShaders.Filename)%(SKShaders.Extension)&quot;" Outputs="@(SKShaders->'%(Filename).sks')"/>
	</Target>

</Project>